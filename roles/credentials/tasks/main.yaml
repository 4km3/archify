---
- name: Gather facts to refresh ansible_env
  tags: credentials
  become: no
  setup:
    
- name: Create ~/.ssh/login-keys.d/
  tags: credentials
  become: no
  file:
    path: "{{ item }}"
    state: directory
  with_items:
    - "{{ ansible_user_dir }}/.ssh/keys.d"
    - "{{ ansible_user_dir }}/.ssh/login-keys.d"
    - "{{ ansible_user_dir }}/.ssh/session-keys.d"

- name: Set credentials for main user
  tags: credentials
  user:
    name: "{{ ansible_user_id }}"
    password: "{{ user_password | mandatory }}"
    generate_ssh_key: yes
    ssh_key_type: ed25519
    ssh_key_file: .ssh/keys.d/id_ed25519
    ssh_key_passphrase: "{{ user_passphrase | mandatory }}"

- name: Symlink ~/.ssh/login-keys.d/id_ed25519 to ~/.ssh/keys.d/id_ed25519
  tags: credentials
  become: no
  file:
    src: "../keys.d/id_ed25519"
    path: "{{ ansible_user_dir }}/.ssh/login-keys.d/id_ed25519"
    state: link
